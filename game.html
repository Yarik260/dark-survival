<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DARK MINIMAL: LASER EDITION</title>
    <style>
        :root { 
            --bg: #0a0a0a; 
            --wall: #1a1a1a;
            --accent: #3498db; 
            --laser: rgba(231, 76, 60, 0.5);
        }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Inter', sans-serif; color: #eee; }
        canvas { display: block; cursor: none; }
        
        #hud { position: absolute; top: 20px; left: 20px; pointer-events: none; display: none; }
        .stat { 
            background: rgba(255,255,255,0.03); padding: 10px 20px; 
            margin-bottom: 5px; border-radius: 4px; border-left: 3px solid var(--accent);
            text-transform: uppercase; letter-spacing: 1px; font-size: 0.9em;
        }

        #menu { 
            position: absolute; inset: 0; background: rgba(10,10,10,0.9); 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(15px); transition: 0.4s;
        }
        .panel { text-align: center; }
        h1 { font-size: 2em; letter-spacing: 5px; margin-bottom: 30px; }
        button { 
            background: var(--accent); color: white; border: none;
            padding: 15px 50px; cursor: pointer; border-radius: 4px;
            font-weight: bold; transition: 0.3s;
        }
        button:hover { background: #2980b9; transform: scale(1.05); }
        .langs { position: absolute; bottom: 20px; }
        .langs button { background: none; padding: 10px; color: #555; font-size: 0.8em; }
        .langs button:hover { color: #fff; }
    </style>
</head>
<body>

    <canvas id="c"></canvas>

    <div id="hud">
        <div class="stat" id="ui_wv">WAVE: 1</div>
        <div class="stat" id="ui_hp">HP: 100</div>
    </div>

    <div id="menu">
        <div class="panel">
            <h1 id="m_title">SURVIVAL</h1>
            <button onclick="actions.start()" id="m_start">START</button>
            <div id="m_score" style="margin-top:20px; opacity:0.5;"></div>
        </div>
        <div class="langs">
            <button onclick="setLang('ru')">RU</button>
            <button onclick="setLang('en')">EN</button>
        </div>
    </div>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');

const I18N = {
    ru: { title: "ТЕМНОТА", start: "ВСТУПИТЬ В БОЙ", wave: "ВОЛНА", hp: "ЦЕЛОСТНОСТЬ", last: "РЕЗУЛЬТАТ: " },
    en: { title: "DARKNESS", start: "ENGAGE", wave: "WAVE", hp: "INTEGRITY", last: "SCORE: " }
};
let L = I18N.ru;
function setLang(lang) {
    L = I18N[lang];
    document.getElementById('m_title').innerText = L.title;
    document.getElementById('m_start').innerText = L.start;
}

// --- КАРТА ---
const TILE = 60;
const WORLD_W = 25; 
const WORLD_H = 18; 
let map = [];

function generateMap() {
    map = [];
    for(let y=0; y<WORLD_H; y++) {
        let row = [];
        for(let x=0; x<WORLD_W; x++) {
            // Границы — всегда стены
            if(x===0 || y===0 || x===WORLD_W-1 || y===WORLD_H-1) row.push(1);
            else row.push(Math.random() < 0.1 ? 1 : 0);
        }
        map.push(row);
    }
    // Центр свободен
    let cx = Math.floor(WORLD_W/2), cy = Math.floor(WORLD_H/2);
    for(let y=cy-2; y<=cy+2; y++) for(let x=cx-2; x<=cx+2; x++) map[y][x] = 0;
}

function isWall(x, y) {
    let col = Math.floor(x / TILE);
    let row = Math.floor(y / TILE);
    return map[row] && map[row][col] === 1;
}

// --- СИСТЕМА ЛАЗЕРА ---
function getLaserEnd(startX, startY, angle) {
    let curX = startX;
    let curY = startY;
    const step = 4; // Точность луча
    for(let d=0; d<1000; d+=step) {
        curX = startX + Math.cos(angle) * d;
        curY = startY + Math.sin(angle) * d;
        if(isWall(curX, curY)) break;
    }
    return {x: curX, y: curY};
}

// --- ИГРОВЫЕ ОБЪЕКТЫ ---
let state = 'MENU';
let wave = 0, enemies = [], bullets = [], particles = [], keys = {};
let mouse = { x:0, y:0, wx:0, wy:0, down:false };
let shake = 0;

const player = {
    x: 0, y: 0, hp: 100, timer: 0, size: 12, spd: 4,
    update() {
        let dx = 0, dy = 0;
        if(keys['KeyW']) dy = -this.spd; if(keys['KeyS']) dy = this.spd;
        if(keys['KeyA']) dx = -this.spd; if(keys['KeyD']) dx = this.spd;
        
        if(!isWall(this.x + dx, this.y - this.size) && !isWall(this.x + dx, this.y + this.size)) this.x += dx;
        if(!isWall(this.x - this.size, this.y + dy) && !isWall(this.x + this.size, this.y + dy)) this.y += dy;

        if(this.timer > 0) this.timer--;
        if(mouse.down && this.timer <= 0) this.shoot();
    },
    shoot() {
        const ang = Math.atan2(mouse.wy - this.y, mouse.wx - this.x);
        bullets.push({ x: this.x, y: this.y, vx: Math.cos(ang)*16, vy: Math.sin(ang)*16, life: 60 });
        this.timer = 10;
        shake = 4;
    }
};

const actions = {
    start() {
        state = 'PLAY'; wave = 0; enemies = []; bullets = []; 
        generateMap(); player.x = (WORLD_W*TILE)/2; player.y = (WORLD_H*TILE)/2; player.hp = 100;
        document.getElementById('menu').style.display = 'none';
        document.getElementById('hud').style.display = 'block';
        nextWave();
    },
    over() {
        state = 'OVER';
        document.getElementById('menu').style.display = 'flex';
        document.getElementById('m_score').innerText = L.last + wave;
    }
};

function nextWave() {
    wave++;
    document.getElementById('ui_wv').innerText = `${L.wave}: ${wave}`;
    for(let i=0; i < 3 + wave; i++) {
        let x, y;
        do { x = Math.random()*WORLD_W*TILE; y = Math.random()*WORLD_H*TILE; } 
        while (isWall(x, y) || Math.hypot(x-player.x, y-player.y) < 300);
        enemies.push({ x, y, hp: 20+wave*10 });
    }
}

function loop() {
    requestAnimationFrame(loop);
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;

    let camX = -player.x + canvas.width/2;
    let camY = -player.y + canvas.height/2;
    
    // Ограничение камеры, чтобы не видеть пустоту за стенами
    camX = Math.min(0, Math.max(camX, -(WORLD_W*TILE - canvas.width)));
    camY = Math.min(0, Math.max(camY, -(WORLD_H*TILE - canvas.height)));

    if(shake > 0) { camX += (Math.random()-0.5)*shake; camY += (Math.random()-0.5)*shake; shake *= 0.9; }
    mouse.wx = mouse.x - camX; mouse.wy = mouse.y - camY;

    ctx.fillStyle = '#0a0a0a';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.save();
    ctx.translate(camX, camY);

    // Стены
    ctx.fillStyle = '#161616';
    for(let y=0; y<WORLD_H; y++) {
        for(let x=0; x<WORLD_W; x++) {
            if(map[y][x] === 1) ctx.fillRect(x*TILE, y*TILE, TILE, TILE);
        }
    }

    if(state === 'PLAY') {
        player.update();
        
        // РИСУЕМ ЛАЗЕР
        const ang = Math.atan2(mouse.wy - player.y, mouse.wx - player.x);
        const laserEnd = getLaserEnd(player.x, player.y, ang);
        ctx.strokeStyle = 'rgba(231, 76, 60, 0.4)';
        ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(player.x, player.y); ctx.lineTo(laserEnd.x, laserEnd.y); ctx.stroke();
        // Точка на конце лазера
        ctx.fillStyle = '#e74c3c'; ctx.beginPath(); ctx.arc(laserEnd.x, laserEnd.y, 2, 0, 7); ctx.fill();

        // Пули
        bullets.forEach((b, i) => {
            b.x += b.vx; b.y += b.vy; b.life--;
            if(isWall(b.x, b.y)) b.life = 0;
            ctx.fillStyle = '#fff'; ctx.fillRect(b.x-2, b.y-2, 4, 4);
            enemies.forEach((e, ei) => {
                if(Math.hypot(b.x-e.x, b.y-e.y) < 20) {
                    e.hp -= 20; b.life = 0;
                    if(e.hp <= 0) enemies.splice(ei, 1);
                }
            });
            if(b.life <= 0) bullets.splice(i, 1);
        });

        // Враги
        if(enemies.length === 0) nextWave();
        enemies.forEach(e => {
            let a = Math.atan2(player.y - e.y, player.x - e.x);
            if(!isWall(e.x + Math.cos(a)*2, e.y)) e.x += Math.cos(a)*2;
            if(!isWall(e.x, e.y + Math.sin(a)*2)) e.y += Math.sin(a)*2;
            ctx.fillStyle = '#e74c3c'; ctx.fillRect(e.x-12, e.y-12, 24, 24);
            if(Math.hypot(e.x-player.x, e.y-player.y) < 25) { player.hp -= 0.5; shake = 5; }
        });

        // Игрок
        ctx.fillStyle = '#3498db'; ctx.fillRect(player.x-12, player.y-12, 24, 24);
        document.getElementById('ui_hp').innerText = `${L.hp}: ${Math.max(0, Math.ceil(player.hp))}`;
        if(player.hp <= 0) actions.over();
    }

    ctx.restore();

    // Прицел
    ctx.strokeStyle = '#fff'; ctx.lineWidth = 1;
    ctx.strokeRect(mouse.x-8, mouse.y-8, 16, 16);
}

window.onkeydown = e => keys[e.code] = true;
window.onkeyup = e => keys[e.code] = false;
window.onmousemove = e => { mouse.x = e.clientX; mouse.y = e.clientY; };
window.onmousedown = () => mouse.down = true;
window.onmouseup = () => mouse.down = false;

setLang('ru'); loop();
</script>
</body>
</html>